<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>å¹¸è¿å¤§è½¬ç›˜ Â· é›¶åç«¯å®Œæ•´ç‰ˆ</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<style>
:root{--w:320px;}
body{margin:0;font:16px/1.5 "Microsoft YaHei";background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);display:flex;justify-content:center;align-items:center;min-height:100vh;flex-direction:column;}
.container{background:#fff;border-radius:16px;padding:20px;width:90%;max-width:400px;box-shadow:0 8px 32px rgba(0,0,0,.3);text-align:center;}
h1{margin:0 0 15px;font-size:24px;color:#333;}
.wheel-box{position:relative;width:var(--w);height:var(--w);margin:0 auto 15px;}
#wheel{width:100%;height:100%;border-radius:50%;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,.25);transition:transform 4s cubic-bezier(.23,1,.32,1);}
.pointer{position:absolute;top:-10px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:12px solid transparent;border-right:12px solid transparent;border-top:24px solid #ff4757;z-index:2;}
button{padding:12px 36px;font-size:18px;color:#fff;background:linear-gradient(45deg,#ff6b6b,#ff4757);border:none;border-radius:30px;cursor:pointer;box-shadow:0 4px 15px rgba(255,107,107,.4);}
button:disabled{background:#ccc;cursor:not-allowed;}
#result{margin:15px 0;min-height:24px;font-weight:bold;}
#stats{font-size:13px;color:#666;}
#qrcode{margin:15px auto;width:180px;height:180px;}
</style>
</head>
<body>
<div class="container">
  <h1>ğŸ‰ å¹¸è¿å¤§è½¬ç›˜ Â· é›¶åç«¯ç‰ˆ</h1>

  <div class="wheel-box">
    <div class="pointer"></div>
    <canvas id="wheel" width="320" height="320"></canvas>
  </div>

  <button id="spinBtn" onclick="startSpin()">å¼€å§‹æŠ½å¥–</button>
  <div id="result">ä»Šæ—¥å‰©ä½™ <span id="remain">-</span> æ¬¡</div>
  <div id="stats">ä¸€ç­‰å¥– <span id="first">-</span> |
              äºŒç­‰å¥– <span id="second">-</span> |
              ä¸‰ç­‰å¥– <span id="third">-</span></div>

  <p style="font-size:12px;color:#999">æ‰«ç å³å¯ç©</p>
  <div id="qrcode"></div>
</div>

<script>
/* ================= 1. Firebase é…ç½®ï¼ˆå¡«è‡ªå·±çš„ï¼‰ ================= */
const firebaseConfig = {
  apiKey: "ä½ çš„apiKey",
  authDomain: "ä½ çš„.firebaseapp.com",
  projectId: "ä½ çš„projectId",
  storageBucket: "ä½ çš„.appspot.com",
  messagingSenderId: "xxx",
  appId: "xxx"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
/* ================= 2. å…¨å±€å˜é‡ ================= */
const LIMIT_PER_DAY = 3;               // æ¯äººæ¯æ—¥æ¬¡æ•°
const prizeCfg = [                     // ç”»å¸ƒé¡ºåºï¼šé€†æ—¶é’ˆ 0Â° å¼€å§‹
  {name:"è°¢è°¢å‚ä¸",color:"#96ceb4",prob:70,remaining:9999},
  {name:"ä¸‰ç­‰å¥–",color:"#4ecdc4",prob:24,remaining:24},
  {name:"äºŒç­‰å¥–",color:"#feca57",prob:5,remaining:5},
  {name:"ä¸€ç­‰å¥–",color:"#ff6b6b",prob:1,remaining:1}
];
let deviceId = localStorage.getItem("deviceId") || 
               ("u_"+Math.random().toString(36).slice(2)+Date.now().toString(36));
localStorage.setItem("deviceId",deviceId);
let remainToday = LIMIT_PER_DAY;
let isSpinning = false;
const prizeRef = db.collection("prize").doc("remaining");
const logRef   = db.collection("draw_log").doc(deviceId);

/* ================= 3. ç”»è½¬ç›˜ ================= */
const canvas = document.getElementById("wheel");
const ctx = canvas.getContext("2d");
const RAD = Math.PI*2/360;
function drawWheel(){
  const ang = 360/prizeCfg.length;
  ctx.clearRect(0,0,320,320);
  prizeCfg.forEach((p,i)=>{
    ctx.beginPath();
    ctx.moveTo(160,160);
    ctx.arc(160,160,160, (i*ang-90)*RAD, ((i+1)*ang-90)*RAD );
    ctx.closePath();
    ctx.fillStyle = p.color;
    ctx.fill();
    ctx.save();
    ctx.translate(160,160);
    ctx.rotate((i*ang+ang/2-90)*RAD);
    ctx.fillStyle="#fff";ctx.font="bold 16px sans-serif";ctx.textAlign="center";
    ctx.fillText(p.name, 120, 6);
    ctx.restore();
  });
}
drawWheel();

/* ================= 4. å®æ—¶åº“å­˜ & ä»Šæ—¥æ¬¡æ•° ================= */
function syncData(){
  // åº“å­˜
  prizeRef.onSnapshot(doc=>{
    if(doc.exists){
      const d=doc.data();
      prizeCfg[1].remaining = d.third;
      prizeCfg[2].remaining = d.second;
      prizeCfg[3].remaining = d.first;
      updateUI();
    }
  });
  // ä»Šæ—¥æ¬¡æ•°
  const today = new Date().toISOString().slice(0,10);
  logRef.get().then(doc=>{
    if(doc.exists && doc.data().date===today){
      remainToday = LIMIT_PER_DAY - doc.data().count;
    }else{
      remainToday = LIMIT_PER_DAY;
    }
    updateUI();
  });
}
function updateUI(){
  document.getElementById("first").textContent  = prizeCfg[3].remaining;
  document.getElementById("second").textContent = prizeCfg[2].remaining;
  document.getElementById("third").textContent  = prizeCfg[1].remaining;
  document.getElementById("remain").textContent = remainToday;
  document.getElementById("spinBtn").disabled = isSpinning || remainToday<=0;
}
syncData();

/* ================= 5. æŠ½å¥– ================= */
async function startSpin(){
  if(isSpinning||remainToday<=0) return;
  isSpinning=true; updateUI();
  document.getElementById("result").textContent="æŠ½å¥–ä¸­...";

  // 5.1 å…ˆæŠ½ä¸­å¥–é¡¹ï¼ˆæŒ‰å‰©ä½™åº“å­˜åŠ æƒï¼‰
  const totalRemain = prizeCfg.reduce((s,c)=>s+c.remaining,0);
  let r=Math.random()*totalRemain,idx=0;
  for(let i=0;i<prizeCfg.length;i++){
    r-= prizeCfg[i].remaining;
    if(r<=0){idx=i;break;}
  }
  const prize = prizeCfg[idx];

  // 5.2 äº‹åŠ¡å‡åº“å­˜ï¼ˆä»…ä¸­å¥–ä¸”éè°¢è°¢å‚ä¸ï¼‰
  if(idx!==0){
    try{
      await db.runTransaction(async t=>{
        const doc=await t.get(prizeRef);
        const key=["third","second","first"][idx-1];
        if(doc.data()[key]<=0) throw "åº“å­˜ä¸è¶³";
        t.update(prizeRef,{[key]:doc.data()[key]-1});
      });
    }catch(e){
      document.getElementById("result").textContent="å¥–å“å·²å‘å®Œï¼"; isSpinning=false; updateUI(); return;
    }
  }

  // 5.3 ç´¯åŠ ä¸ªäººæ¬¡æ•°
  const today = new Date().toISOString().slice(0,10);
  await logRef.set({date:today, count: LIMIT_PER_DAY - remainToday +1},{merge:true});
  remainToday--;

  // 5.4 æ—‹è½¬åŠ¨ç”»
  const ang = 360/prizeCfg.length;
  const target = (idx*ang + ang/2 -90 + 3600 + Math.random()*ang*0.8)|0;
  canvas.style.transform=`rotate(${target}deg)`;

  setTimeout(()=>{
    isSpinning=false; updateUI();
    document.getElementById("result").innerHTML=
      idx===0 ? "ğŸ˜Š è°¢è°¢å‚ä¸ï¼Œæ˜æ—¥å†æ¥ï¼" : `ğŸ‰ æ­å–œè·å¾—ï¼š${prize.name}ï¼`;
  },4200);
}

/* ================= 6. ç°åœºäºŒç»´ç ï¼ˆé¡µé¢åœ°å€ï¼‰ ================= */
new QRCode(document.getElementById("qrcode"),{
  text: location.href.replace(/^http:/,"https:"),
  width:180,height:180,colorDark:"#000",colorLight:"#fff",correctLevel:QRCode.CorrectLevel.H
});
</script>
</body>
</html>
